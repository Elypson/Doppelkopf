<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>

    <script>
        var log = (msg) => document.getElementById('output').innerHTML += msg + "<br/>";

        function connect(username) {
            (_ => log("started!"))();

            ws = new WebSocket("wss://localhost:5001/server");

            log(ws.protocol);

            ws.addEventListener('open', function (event) {
                log("Connection opened");
                ws.send('Hello Server!');
            });

            ws.addEventListener('message', function (event) {
                const obj = JSON.parse(event.data);

                console.log(event.data);

                switch (obj.Type) {
                    case 0: /* META */
                        switch (obj.SubType) {
                            case 'token':
                                token = obj.Text;
                                ws.send('{"Type":0,"SubType":"name","Text":"' + username + '"}');
                                myUsername = username;
                                break;
                            case 'join':
                                log(">> " + obj.Text + " has joined.");
                                break;
                            case 'quit':
                                log(">> " + obj.Text + " has left.");
                        }
                        break;

                    case 1: /* CHAT */
                        log(obj.Username + ": " + obj.Text);
                        break;
                }
            });

            ws.addEventListener('close', function (event) {
                log('Connection closed, my token is ' + token);
            });

            
        };

        function sendMessage() {
            var messageInput = document.getElementsByName('message')[0];
            log('<span style="color:#00a">' + myUsername + ": " + messageInput.value + '</span>');
            ws.send(JSON.stringify({ "Type": 1, "Text": messageInput.value }));
            messageInput.value = "";
            messageInput.focus();
        }
    </script>
</head>
<body>
    <div id="output"></div>

    <input tabindex="1" type="text" name="username" placeholder="Your nick" />
    <input tabindex="2" type="button" value="Join" onclick="connect(document.getElementsByName('username')[0].value)" />
                                                                        
    <input tabindex="3" type="text" name="message" onkeypress="if(event.which == 13 || event.keyCode == 13) sendMessage();"/>
    <input tabindex="4" type="button" value="Send" onclick="sendMessage();" />
    <input tabindex="5" type="button" value="Close" onclick="ws.close();" />
</body>
</html>
